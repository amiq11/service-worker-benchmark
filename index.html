<!DOCTYPE html>
<html>
<head>
  <title>SW speed test</title>
  <style>
    .images {
      display: flex;
      flex-flow: row wrap;
      width: 400px;
      background: #ccc;
    }
    .images img {
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <h1>SW Benchmark</h1>
  <div class="images">
    <img src="images/0.png">
    <img src="images/1.png">
    <img src="images/2.png">
    <img src="images/3.png">
    <img src="images/4.png">
    <img src="images/5.png">
    <img src="images/6.png">
    <img src="images/7.png">
    <img src="images/8.png">
    <img src="images/9.png">
    <img src="images/10.png">
    <img src="images/11.png">
    <img src="images/12.png">
    <img src="images/13.png">
    <img src="images/14.png">
    <img src="images/15.png">
    <img src="images/16.png">
    <img src="images/17.png">
    <img src="images/18.png">
    <img src="images/19.png">
    <img src="images/20.png">
    <img src="images/21.png">
    <img src="images/22.png">
    <img src="images/23.png">
    <img src="images/24.png">
    <img src="images/25.png">
    <img src="images/26.png">
    <img src="images/27.png">
    <img src="images/28.png">
    <img src="images/29.png">
    <img src="images/30.png">
    <img src="images/31.png">
    <img src="images/32.png">
    <img src="images/33.png">
    <img src="images/34.png">
    <img src="images/35.png">
    <img src="images/36.png">
    <img src="images/37.png">
    <img src="images/38.png">
    <img src="images/39.png">
    <img src="images/40.png">
    <img src="images/41.png">
    <img src="images/42.png">
    <img src="images/43.png">
    <img src="images/44.png">
    <img src="images/45.png">
    <img src="images/46.png">
    <img src="images/47.png">
    <img src="images/48.png">
    <img src="images/49.png">
    <img src="images/50.png">
    <img src="images/51.png">
    <img src="images/52.png">
    <img src="images/53.png">
    <img src="images/54.png">
    <img src="images/55.png">
    <img src="images/56.png">
    <img src="images/57.png">
    <img src="images/58.png">
    <img src="images/59.png">
    <img src="images/60.png">
    <img src="images/61.png">
    <img src="images/62.png">
    <img src="images/63.png">
    <img src="images/64.png">
    <img src="images/65.png">
    <img src="images/66.png">
    <img src="images/67.png">
    <img src="images/68.png">
    <img src="images/69.png">
    <img src="images/70.png">
    <img src="images/71.png">
    <img src="images/72.png">
    <img src="images/73.png">
    <img src="images/74.png">
    <img src="images/75.png">
    <img src="images/76.png">
    <img src="images/77.png">
    <img src="images/78.png">
    <img src="images/79.png">
    <img src="images/80.png">
    <img src="images/81.png">
    <img src="images/82.png">
    <img src="images/83.png">
    <img src="images/84.png">
    <img src="images/85.png">
    <img src="images/86.png">
    <img src="images/87.png">
    <img src="images/88.png">
    <img src="images/89.png">
    <img src="images/90.png">
    <img src="images/91.png">
    <img src="images/92.png">
    <img src="images/93.png">
    <img src="images/94.png">
    <img src="images/95.png">
    <img src="images/96.png">
    <img src="images/97.png">
    <img src="images/98.png">
    <img src="images/99.png">
    <img src="images/100.png">
    <img src="images/101.png">
  </div>
  <div class="results"></div>
  <div class="sw-status"></div>
  <div class="controls"></div>
  <script>
    window.onload = () => {
      const timing = performance.timing;
      const controls = document.querySelector('.controls');
      const swStatus = document.querySelector('.sw-status');
      const sw = navigator.serviceWorker;

      document.querySelector('.results').textContent = `${timing.loadEventStart - timing.navigationStart}ms from nav start to onload start`;

      function logActiveWorker() {
        sw.getRegistration().then(reg => {
          if (!reg) {
            swStatus.textContent = 'No service worker';
            return;
          }
          if (!reg.active) {
            watchUpdate(reg);
            return;
          }
          swStatus.textContent = `${/\/([^\/]+)$/.exec(reg.active.scriptURL)[1]} active`;
        });
      }

      logActiveWorker();

      function watchUpdate(reg) {
        const worker = reg.installing;

        if (!worker) {
          swStatus.textContent = 'Already installed';
          return;
        }

        swStatus.textContent = 'Installing';

        worker.addEventListener('statechange', function listener() {
          if (worker.state == 'activated') {
            logActiveWorker();
            worker.removeEventListener('statechange', listener);
          }
          else if (worker.state == 'redundant') {
            updateError();
          }
        });
      }

      function updateError() {
        swStatus.textContent = 'Update error';
      }

      function createButton(text, event) {
        const button = document.createElement('button');
        button.textContent = text;
        button.onclick = event;
        return button;
      }
      
      controls.appendChild(createButton("Unregister", () => {
        sw.getRegistration().then(r => r && r.unregister())
          .then(() => swStatus.textContent = 'Unregistered');
      }));

      controls.appendChild(createButton("Register no-fetch worker", () => {
        sw.register('no-fetch.js').then(watchUpdate, updateError);
      }));

      controls.appendChild(createButton("Register empty-fetch worker", () => {
        sw.register('empty-fetch.js').then(watchUpdate, updateError);
      }));

      controls.appendChild(createButton("Register pass-through worker", () => {
        sw.register('pass-through-fetch.js').then(watchUpdate, updateError);
      }));

      controls.appendChild(createButton("Register blocking worker", () => {
        sw.register('blocking-fetch.js').then(watchUpdate, updateError);
      }));

      controls.appendChild(createButton("Register caching worker", () => {
        sw.register('cached-fetch.js').then(watchUpdate, updateError);
      }));
    };
  </script>
</body>
</html>
